{
  "name": "AIR TABLE TO BREVO",
  "nodes": [
    {
      "parameters": {
        "resource": "base",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        208,
        0
      ],
      "id": "35607f7e-53b2-49a8-8e0f-bb9709824c4a",
      "name": "Get many bases",
      "credentials": {
        "airtableTokenApi": {
          "id": "c205Wg2ah4O28YiY",
          "name": "Airtable Personal Access Token account 2"
        }
      }
    },
    {
      "parameters": {
        "resource": "base",
        "operation": "getSchema",
        "base": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        }
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        416,
        0
      ],
      "id": "813acb76-af01-485e-94e8-8aa7d8250c9b",
      "name": "Get base schema",
      "credentials": {
        "airtableTokenApi": {
          "id": "c205Wg2ah4O28YiY",
          "name": "Airtable Personal Access Token account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6440db88-2199-479f-b4b8-9b16add1b7f4",
              "name": "base_id",
              "value": "={{ $('Get many bases').item.json.id }}",
              "type": "string"
            },
            {
              "id": "8bd5885d-c894-4a6c-9f43-1892f54e8a31",
              "name": "table_name",
              "value": "\tContacts",
              "type": "string"
            },
            {
              "id": "3f889809-861e-4553-bf0e-1d78cf56759d",
              "name": "offset",
              "value": "={{ $json.offset }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        624,
        0
      ],
      "id": "30798ebb-dab5-4394-8e63-1f658688e6dc",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "url": "=https://api.airtable.com/v0/{{ $json.base_id }}/{{ $json.table_name }}?offset={{ $json.offset }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": ""
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        832,
        0
      ],
      "id": "0a610071-2613-4dae-b015-ca1046ecd556",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a4bb47b7-0345-4b92-81ec-b8efca3ee39e",
              "name": "offset",
              "value": "={{ $json.offset }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1248,
        0
      ],
      "id": "f81ae2c9-f30e-4b88-b3fb-2d007b5d58d9",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8a5649be-4aaa-4bb0-85b2-a173ec7383db",
              "leftValue": "={{ $json.offset }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1456,
        0
      ],
      "id": "7f281917-989a-4e6f-ae20-e7f1f2687d8c",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1776,
        -16
      ],
      "id": "60e9c480-1bd6-41b1-a8d0-d1af3929b312",
      "name": "Wait",
      "webhookId": "ea5c8f28-f49a-4bef-945c-7185e854fb59"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.brevo.com/v3/contacts",
        "authentication": "",
        "nodeCredentialType": "sendInBlueApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"email\": \"{{ $json.email }}\",\n  \"updateEnabled\": true,\n  \"attributes\": {\n    \"FORMALITY_FINAL\": \"{{ $json.formality_final }}\"\n  },\n  \"listIds\": []\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1680,
        384
      ],
      "id": "24f9c971-fd20-4f10-b126-6be5deebaa3a",
      "name": "HTTP Request1",
      "credentials": {
        "sendInBlueApi": {
          "id": "Go43qpfHWI7RI2DZ",
          "name": "Brevo account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„ÙÙˆØ±Ù…Ø§ØªÙŠ ÙÙ‚Ø· Ù„Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø¨Ø±ÙŠÙÙˆ\nconst items = $input.all();\n\nlet contactsToUpdate = [];\n\nitems.forEach(item => {\n  if (item.records && Array.isArray(item.records)) {\n    item.records.forEach(record => {\n      if (record.fields && record.fields.Email && record.fields.formality_final) {\n        contactsToUpdate.push({\n          email: record.fields.Email,\n          formality_final: record.fields.formality_final\n        });\n      }\n    });\n  }\n});\n\n// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª\nconst uniqueContacts = contactsToUpdate.filter((item, index, self) => \n  index === self.findIndex(t => t.email === item.email)\n);\n\nreturn uniqueContacts;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        0
      ],
      "id": "096a2db5-b2fb-4c5e-98b5-d8625cde1568",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "// ÙƒÙˆØ¯ Ù…Ø¹Ø¯Ù„ Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ ÙˆÙØ­Øµ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª\nconst items = $input.all();\n\nconsole.log('=== ÙØ­Øµ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===');\nconsole.log('Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', typeof items);\nconsole.log('Ù‡Ù„ array?:', Array.isArray(items));\nconsole.log('Ø§Ù„Ø·ÙˆÙ„:', items.length);\n\nif (items.length === 0) {\n    console.log('âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©');\n    return [];\n}\n\n// ÙØ­Øµ Ø£ÙˆÙ„ Ø¹Ù†ØµØ± Ø¨Ø§Ù„ØªÙØµÙŠÙ„\nconst firstItem = items[0];\nconsole.log('Ø£ÙˆÙ„ Ø¹Ù†ØµØ±:', JSON.stringify(firstItem, null, 2));\nconsole.log('Ù…ÙØ§ØªÙŠØ­ Ø£ÙˆÙ„ Ø¹Ù†ØµØ±:', Object.keys(firstItem));\n\n// Ø¥Ø°Ø§ ÙÙŠÙ‡ records\nif (firstItem.records) {\n    console.log('âœ… ÙŠÙˆØ¬Ø¯ records');\n    console.log('Ù†ÙˆØ¹ records:', typeof firstItem.records);\n    console.log('Ø·ÙˆÙ„ records:', firstItem.records.length);\n    \n    if (firstItem.records.length > 0) {\n        const firstRecord = firstItem.records[0];\n        console.log('Ø£ÙˆÙ„ record:', JSON.stringify(firstRecord, null, 2));\n        console.log('Ù…ÙØ§ØªÙŠØ­ Ø£ÙˆÙ„ record:', Object.keys(firstRecord));\n        \n        if (firstRecord.fields) {\n            console.log('âœ… ÙŠÙˆØ¬Ø¯ fields');\n            console.log('Ù…ÙØ§ØªÙŠØ­ fields:', Object.keys(firstRecord.fields));\n            console.log('Ù‚ÙŠÙ…Ø© Email:', firstRecord.fields.Email);\n            console.log('Ù‚ÙŠÙ…Ø© formality_final:', firstRecord.fields.formality_final);\n        } else {\n            console.log('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ fields');\n        }\n    }\n} else {\n    console.log('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ records');\n}\n\n// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„\nfunction cleanAndValidateEmail(email) {\n    if (!email || typeof email !== 'string') {\n        return { isValid: false, cleanEmail: null, reason: 'Ù„ÙŠØ³ Ù†ØµØ§Ù‹' };\n    }\n    \n    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª\n    const cleanEmail = email.trim();\n    \n    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ\n    if (cleanEmail === '') {\n        return { isValid: false, cleanEmail: null, reason: 'ÙØ§Ø±Øº Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ' };\n    }\n    \n    // regex Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„\n    const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\\.[a-zA-Z0-9-]+)*$/;\n    \n    if (emailRegex.test(cleanEmail)) {\n        return { isValid: true, cleanEmail: cleanEmail, reason: 'ØµØ§Ù„Ø­' };\n    } else {\n        return { isValid: false, cleanEmail: cleanEmail, reason: 'ØµÙŠØºØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©' };\n    }\n}\n\n// Ø§Ù„Ø¢Ù† Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\nlet extractedData = [];\nlet validCount = 0;\nlet invalidCount = 0;\n\nif (firstItem.records && Array.isArray(firstItem.records)) {\n    console.log('ðŸ” Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');\n    \n    firstItem.records.forEach((record, index) => {\n        if (record.fields && record.fields.Email) {\n            const emailValidation = cleanAndValidateEmail(record.fields.Email);\n            \n            if (emailValidation.isValid) {\n                extractedData.push({\n                    email: emailValidation.cleanEmail,\n                    formality_final: record.fields.formality_final || 'SIE'\n                });\n                validCount++;\n                console.log(`âœ… Record ${index}: ${emailValidation.cleanEmail}`);\n            } else {\n                invalidCount++;\n                console.log(`âŒ Record ${index}: \"${record.fields.Email}\" -> ${emailValidation.reason}`);\n            }\n        }\n    });\n}\n\nconsole.log(`ðŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${validCount} Ø¥ÙŠÙ…ÙŠÙ„ ØµØ§Ù„Ø­, ${invalidCount} Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­`);\n\nif (extractedData.length === 0) {\n    console.log('âš ï¸  Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©ØŒ Ø¬Ø±Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©...');\n    \n    // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©: Ø§Ù„Ø¨Ø­Ø« ÙÙŠ JSON ÙƒØ§Ù…Ù„\n    const jsonString = JSON.stringify(items);\n    console.log('Ø§Ù„Ø¨Ø­Ø« ÙÙŠ JSON...');\n    \n    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… regex\n    const emailRegex = /\"Email\"\\s*:\\s*\"([^\"]+)\"/g;\n    let match;\n    let emailCount = 0;\n    \n    while ((match = emailRegex.exec(jsonString)) !== null) {\n        const emailValidation = cleanAndValidateEmail(match[1]);\n        \n        if (emailValidation.isValid) {\n            emailCount++;\n            console.log(`âœ… ÙˆØ¬Ø¯Øª Ø¥ÙŠÙ…ÙŠÙ„ ${emailCount}: ${emailValidation.cleanEmail}`);\n            extractedData.push({\n                email: emailValidation.cleanEmail,\n                formality_final: 'SIE'\n            });\n        } else {\n            console.log(`âŒ Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­: \"${match[1]}\" -> ${emailValidation.reason}`);\n        }\n    }\n    \n    console.log(`Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Regex: ${emailCount} Ø¥ÙŠÙ…ÙŠÙ„ ØµØ§Ù„Ø­`);\n}\n\n// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©\nconst uniqueEmails = extractedData.filter((item, index, self) => \n    index === self.findIndex(t => t.email === item.email)\n);\n\nconsole.log(`ðŸŽ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${uniqueEmails.length} Ø¥ÙŠÙ…ÙŠÙ„ ØµØ§Ù„Ø­ ÙˆÙØ±ÙŠØ¯`);\nconsole.log('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„ØµØ§Ù„Ø­Ø©:', uniqueEmails.map(item => item.email));\n\nreturn uniqueEmails;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1168,
        368
      ],
      "id": "09406230-c1b8-4282-ae7d-33b250371e73",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1392,
        368
      ],
      "id": "e4123d93-a0da-4b67-b980-93002d38d914",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1904,
        384
      ],
      "id": "d024ce40-d867-4b9e-85b1-e694bff74f75",
      "name": "Wait1",
      "webhookId": "be0d9d23-80a5-45f2-86aa-eeb2faf3c09b"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ],
      "id": "bbf1563d-479b-47b1-9bd4-e23121853b50",
      "name": "Schedule Trigger"
    }
  ],
  "pinData": {},
  "connections": {
    "Get many bases": {
      "main": [
        [
          {
            "node": "Get base schema",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get base schema": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        []
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Get many bases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5474992b-22c6-44fd-94f0-2dfb082b00a7",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0e0dd4afc9011baa03e91be45fcf2e4b4ed5ae3ca100515f64a55d48735dad8f"
  },
  "id": "Tbxb6NNsx9wq6XSK",
  "tags": []
}